<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>端口扫描器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 33%, rgba(255,255,255,0.3) 33%, rgba(255,255,255,0.3) 66%, transparent 66%);
            background-size: 20px 20px;
            animation: progress-stripes 1s linear infinite;
        }

        @keyframes progress-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .progress-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .progress-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .progress-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .speed-indicator {
            display: inline-block;
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .port-list {
            display: grid;
            gap: 10px;
        }

        .port-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .port-item.open {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .port-item.closed {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }

        .port-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .port-number {
            font-weight: bold;
            font-size: 1.1em;
        }

        .service-name {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .status {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 端口扫描器</h1>
            <p>快速扫描目标主机的开放端口</p>
        </div>
        
        <div class="content">
            <form id="scanForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="target">目标地址</label>
                        <input type="text" id="target" name="target" placeholder="例如: 192.168.1.1 或 example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="ports">端口范围</label>
                        <select id="ports" name="ports">
                            <option value="all">常用端口 (推荐)</option>
                            <option value="1-1000">1-1000</option>
                            <option value="1-65535">全部端口 (1-65535)</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="customPortsGroup" style="display: none;">
                    <label for="customPorts">自定义端口</label>
                    <input type="text" id="customPorts" name="customPorts" placeholder="例如: 80,443,8080 或 22-25,80,443">
                </div>
                
                <button type="submit" class="btn" id="scanBtn">
                    🚀 开始扫描
                </button>
            </form>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>正在扫描端口，请稍候...</p>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <h4>扫描进度</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-info">
                    <div class="progress-item">
                        <div class="progress-value" id="progressPercent">0%</div>
                        <div class="progress-label">完成进度</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-value" id="progressCompleted">0</div>
                        <div class="progress-label">已扫描</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-value" id="progressTotal">0</div>
                        <div class="progress-label">总端口</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-value" id="progressOpen">0</div>
                        <div class="progress-label">开放端口</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-value" id="progressSpeed">0</div>
                        <div class="progress-label">端口/秒</div>
                    </div>
                    <div class="progress-item" id="batchInfo" style="display: none;">
                        <div class="progress-value" id="progressBatch">-</div>
                        <div class="progress-label">当前批次</div>
                    </div>
                </div>
            </div>
            
            <div class="error" id="error" style="display: none;"></div>
            
            <div class="results" id="results">
                <h3>扫描结果</h3>
                <div class="stats" id="stats"></div>
                <div class="port-list" id="portList"></div>
            </div>
        </div>
    </div>

    <script>
        const scanForm = document.getElementById('scanForm');
        const loading = document.getElementById('loading');
        const progressContainer = document.getElementById('progressContainer');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        const scanBtn = document.getElementById('scanBtn');
        const portsSelect = document.getElementById('ports');
        const customPortsGroup = document.getElementById('customPortsGroup');
        const customPorts = document.getElementById('customPorts');
        
        // 进度显示元素
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');
        const progressCompleted = document.getElementById('progressCompleted');
        const progressTotal = document.getElementById('progressTotal');
        const progressOpen = document.getElementById('progressOpen');
        const progressSpeed = document.getElementById('progressSpeed');
        
        let currentSessionId = null;
        let progressEventSource = null;

        // 显示/隐藏自定义端口输入框
        portsSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customPortsGroup.style.display = 'block';
                customPorts.required = true;
            } else {
                customPortsGroup.style.display = 'none';
                customPorts.required = false;
            }
        });

        // 表单提交处理
        scanForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const target = document.getElementById('target').value.trim();
            let ports = portsSelect.value;
            
            if (ports === 'custom') {
                ports = customPorts.value.trim();
                if (!ports) {
                    showError('请输入自定义端口');
                    return;
                }
            }
            
            if (!target) {
                showError('请输入目标地址');
                return;
            }
            
            // 开始扫描
            startScan(target, ports);
        });

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            results.style.display = 'none';
        }

        function hideError() {
            error.style.display = 'none';
        }

        async function startScan(target, ports) {
            // 显示进度容器
            progressContainer.style.display = 'block';
            loading.style.display = 'none';
            results.style.display = 'none';
            hideError();
            scanBtn.disabled = true;
            scanBtn.textContent = '扫描中...';
            
            // 重置进度显示
            updateProgress(0, 0, 0, 0, 0);
            
            try {
                const formData = new FormData();
                formData.append('target', target);
                formData.append('ports', ports);
                
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
                const data = await response.json();
                currentSessionId = data.sessionId;
                
                // 开始监听进度更新
                startProgressListener();
                
            } catch (err) {
                showError('扫描失败: ' + err.message);
                progressContainer.style.display = 'none';
                scanBtn.disabled = false;
                scanBtn.textContent = '🚀 开始扫描';
            }
        }
        
        function startProgressListener() {
            if (progressEventSource) {
                progressEventSource.close();
            }
            
            progressEventSource = new EventSource(`/api/progress?sessionId=${currentSessionId}`);
            let lastUpdateTime = Date.now();
            
            // 心跳检测
            const heartbeatInterval = setInterval(() => {
                if (Date.now() - lastUpdateTime > 30000) { // 30秒没有更新
                    console.log('进度更新超时，尝试重新连接...');
                    if (progressEventSource) {
                        progressEventSource.close();
                        progressEventSource = null;
                    }
                    clearInterval(heartbeatInterval);
                    if (currentSessionId) {
                        startProgressListener();
                    }
                }
            }, 10000); // 每10秒检查一次
            
            progressEventSource.onmessage = function(event) {
                lastUpdateTime = Date.now();
                const data = JSON.parse(event.data);
                
                if (data.type === 'progress') {
                    updateProgress(data.completed, data.total, data.percent, data.openPorts, data.speed, data.batchInfo);
                } else if (data.type === 'complete') {
                    // 扫描完成
                    clearInterval(heartbeatInterval);
                    progressEventSource.close();
                    progressEventSource = null;
                    
                    // 立即获取扫描结果，不等待
                    setTimeout(() => fetchResults(), 100);
                }
            };
            
            progressEventSource.onerror = function(event) {
                console.error('进度监听错误:', event);
                // 不要立即关闭，可能是网络问题
                setTimeout(() => {
                    if (progressEventSource && progressEventSource.readyState === EventSource.CLOSED) {
                        console.log('尝试重新连接进度监听...');
                        progressEventSource.close();
                        progressEventSource = null;
                        // 重新建立连接
                        setTimeout(() => {
                            if (currentSessionId) {
                                startProgressListener();
                            }
                        }, 2000);
                    }
                }, 5000);
            };
        }
        
        function updateProgress(completed, total, percent, openPorts, speed, batchInfo) {
            progressFill.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressCompleted.textContent = completed;
            progressTotal.textContent = total;
            progressOpen.textContent = openPorts;
            progressSpeed.textContent = speed;
            
            // 显示批次信息
            if (batchInfo) {
                document.getElementById('batchInfo').style.display = 'block';
                document.getElementById('progressBatch').textContent = batchInfo;
            } else {
                document.getElementById('batchInfo').style.display = 'none';
            }
        }
        
        async function fetchResults(retryCount = 0) {
            try {
                const response = await fetch(`/api/results?sessionId=${currentSessionId}`);
                if (!response.ok) {
                    if (response.status === 404 && retryCount < 3) {
                        // 会话不存在，等待一下再重试
                        console.log(`重试获取结果 (${retryCount + 1}/3)...`);
                        setTimeout(() => fetchResults(retryCount + 1), 1000);
                        return;
                    }
                    throw new Error(`获取结果失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // 隐藏进度，显示结果
                progressContainer.style.display = 'none';
                scanBtn.disabled = false;
                scanBtn.textContent = '🚀 开始扫描';
                
                // 显示结果
                displayResults(data.results);
                
                currentSessionId = null;
                
            } catch (err) {
                if (retryCount < 3) {
                    console.log(`获取结果失败，重试中 (${retryCount + 1}/3):`, err.message);
                    setTimeout(() => fetchResults(retryCount + 1), 1000);
                } else {
                    showError('获取扫描结果失败: ' + err.message);
                    progressContainer.style.display = 'none';
                    scanBtn.disabled = false;
                    scanBtn.textContent = '🚀 开始扫描';
                }
            }
        }

        function displayResults(portResults) {
            const openPorts = portResults.filter(port => port.open);
            const closedPorts = portResults.filter(port => !port.open);
            
            // 显示统计信息
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${portResults.length}</div>
                    <div class="stat-label">总端口数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${openPorts.length}</div>
                    <div class="stat-label">开放端口</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${closedPorts.length}</div>
                    <div class="stat-label">关闭端口</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round((openPorts.length / portResults.length) * 100)}%</div>
                    <div class="stat-label">开放率</div>
                </div>
            `;
            
            // 显示端口列表
            const portList = document.getElementById('portList');
            portList.innerHTML = '';
            
            // 先显示开放的端口
            openPorts.forEach(port => {
                const portItem = createPortItem(port, true);
                portList.appendChild(portItem);
            });
            
            // 再显示关闭的端口
            closedPorts.forEach(port => {
                const portItem = createPortItem(port, false);
                portList.appendChild(portItem);
            });
            
            results.style.display = 'block';
        }

        function createPortItem(port, isOpen) {
            const portItem = document.createElement('div');
            portItem.className = `port-item ${isOpen ? 'open' : 'closed'}`;
            
            portItem.innerHTML = `
                <div class="port-info">
                    <div class="port-number">端口 ${port.port}</div>
                    <div class="service-name">${port.service}</div>
                </div>
                <div class="status">${isOpen ? '开放' : '关闭'}</div>
            `;
            
            return portItem;
        }
    </script>
</body>
</html>


