<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¯å£æ‰«æå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 33%, rgba(255,255,255,0.3) 33%, rgba(255,255,255,0.3) 66%, transparent 66%);
            background-size: 20px 20px;
            animation: progress-stripes 1s linear infinite;
        }

        @keyframes progress-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .progress-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .progress-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .progress-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .speed-indicator {
            display: inline-block;
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .port-list {
            display: grid;
            gap: 10px;
        }

        .port-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .port-item.open {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .port-item.closed {
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }

        .port-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .port-number {
            font-weight: bold;
            font-size: 1.1em;
        }

        .service-name {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .status {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ç«¯å£æ‰«æå™¨</h1>
            <p>å¿«é€Ÿæ‰«æç›®æ ‡ä¸»æœºçš„å¼€æ”¾ç«¯å£</p>
        </div>
        
        <div class="content">
            <form id="scanForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="target">ç›®æ ‡åœ°å€</label>
                        <input type="text" id="target" name="target" placeholder="ä¾‹å¦‚: 192.168.1.1 æˆ– example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="ports">ç«¯å£èŒƒå›´</label>
                        <select id="ports" name="ports">
                            <option value="all">å¸¸ç”¨ç«¯å£ (æ¨è)</option>
                            <option value="1-1000">1-1000</option>
                            <option value="1-65535">å…¨éƒ¨ç«¯å£ (1-65535)</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="customPortsGroup" style="display: none;">
                    <label for="customPorts">è‡ªå®šä¹‰ç«¯å£</label>
                    <input type="text" id="customPorts" name="customPorts" placeholder="ä¾‹å¦‚: 80,443,8080 æˆ– 22-25,80,443">
                </div>
                
                <button type="submit" class="btn" id="scanBtn">
                    ğŸš€ å¼€å§‹æ‰«æ
                </button>
            </form>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æ‰«æç«¯å£ï¼Œè¯·ç¨å€™...</p>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <h4>æ‰«æè¿›åº¦</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-info">
                    <div class="progress-item">
                        <div class="progress-value" id="progressPercent">0%</div>
                        <div class="progress-label">å®Œæˆè¿›åº¦</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-value" id="progressCompleted">0</div>
                        <div class="progress-label">å·²æ‰«æ</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-value" id="progressTotal">0</div>
                        <div class="progress-label">æ€»ç«¯å£</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-value" id="progressOpen">0</div>
                        <div class="progress-label">å¼€æ”¾ç«¯å£</div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-value" id="progressSpeed">0</div>
                        <div class="progress-label">ç«¯å£/ç§’</div>
                    </div>
                    <div class="progress-item" id="batchInfo" style="display: none;">
                        <div class="progress-value" id="progressBatch">-</div>
                        <div class="progress-label">å½“å‰æ‰¹æ¬¡</div>
                    </div>
                </div>
            </div>
            
            <div class="error" id="error" style="display: none;"></div>
            
            <div class="results" id="results">
                <h3>æ‰«æç»“æœ</h3>
                <div class="stats" id="stats"></div>
                <div class="port-list" id="portList"></div>
            </div>
        </div>
    </div>

    <script>
        const scanForm = document.getElementById('scanForm');
        const loading = document.getElementById('loading');
        const progressContainer = document.getElementById('progressContainer');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        const scanBtn = document.getElementById('scanBtn');
        const portsSelect = document.getElementById('ports');
        const customPortsGroup = document.getElementById('customPortsGroup');
        const customPorts = document.getElementById('customPorts');
        
        // è¿›åº¦æ˜¾ç¤ºå…ƒç´ 
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');
        const progressCompleted = document.getElementById('progressCompleted');
        const progressTotal = document.getElementById('progressTotal');
        const progressOpen = document.getElementById('progressOpen');
        const progressSpeed = document.getElementById('progressSpeed');
        
        let currentSessionId = null;
        let progressEventSource = null;

        // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰ç«¯å£è¾“å…¥æ¡†
        portsSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customPortsGroup.style.display = 'block';
                customPorts.required = true;
            } else {
                customPortsGroup.style.display = 'none';
                customPorts.required = false;
            }
        });

        // è¡¨å•æäº¤å¤„ç†
        scanForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const target = document.getElementById('target').value.trim();
            let ports = portsSelect.value;
            
            if (ports === 'custom') {
                ports = customPorts.value.trim();
                if (!ports) {
                    showError('è¯·è¾“å…¥è‡ªå®šä¹‰ç«¯å£');
                    return;
                }
            }
            
            if (!target) {
                showError('è¯·è¾“å…¥ç›®æ ‡åœ°å€');
                return;
            }
            
            // å¼€å§‹æ‰«æ
            startScan(target, ports);
        });

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            results.style.display = 'none';
        }

        function hideError() {
            error.style.display = 'none';
        }

        async function startScan(target, ports) {
            // æ˜¾ç¤ºè¿›åº¦å®¹å™¨
            progressContainer.style.display = 'block';
            loading.style.display = 'none';
            results.style.display = 'none';
            hideError();
            scanBtn.disabled = true;
            scanBtn.textContent = 'æ‰«æä¸­...';
            
            // é‡ç½®è¿›åº¦æ˜¾ç¤º
            updateProgress(0, 0, 0, 0, 0);
            
            try {
                const formData = new FormData();
                formData.append('target', target);
                formData.append('ports', ports);
                
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
                const data = await response.json();
                currentSessionId = data.sessionId;
                
                // å¼€å§‹ç›‘å¬è¿›åº¦æ›´æ–°
                startProgressListener();
                
            } catch (err) {
                showError('æ‰«æå¤±è´¥: ' + err.message);
                progressContainer.style.display = 'none';
                scanBtn.disabled = false;
                scanBtn.textContent = 'ğŸš€ å¼€å§‹æ‰«æ';
            }
        }
        
        function startProgressListener() {
            if (progressEventSource) {
                progressEventSource.close();
            }
            
            progressEventSource = new EventSource(`/api/progress?sessionId=${currentSessionId}`);
            let lastUpdateTime = Date.now();
            
            // å¿ƒè·³æ£€æµ‹
            const heartbeatInterval = setInterval(() => {
                if (Date.now() - lastUpdateTime > 30000) { // 30ç§’æ²¡æœ‰æ›´æ–°
                    console.log('è¿›åº¦æ›´æ–°è¶…æ—¶ï¼Œå°è¯•é‡æ–°è¿æ¥...');
                    if (progressEventSource) {
                        progressEventSource.close();
                        progressEventSource = null;
                    }
                    clearInterval(heartbeatInterval);
                    if (currentSessionId) {
                        startProgressListener();
                    }
                }
            }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
            
            progressEventSource.onmessage = function(event) {
                lastUpdateTime = Date.now();
                const data = JSON.parse(event.data);
                
                if (data.type === 'progress') {
                    updateProgress(data.completed, data.total, data.percent, data.openPorts, data.speed, data.batchInfo);
                } else if (data.type === 'complete') {
                    // æ‰«æå®Œæˆ
                    clearInterval(heartbeatInterval);
                    progressEventSource.close();
                    progressEventSource = null;
                    
                    // ç«‹å³è·å–æ‰«æç»“æœï¼Œä¸ç­‰å¾…
                    setTimeout(() => fetchResults(), 100);
                }
            };
            
            progressEventSource.onerror = function(event) {
                console.error('è¿›åº¦ç›‘å¬é”™è¯¯:', event);
                // ä¸è¦ç«‹å³å…³é—­ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜
                setTimeout(() => {
                    if (progressEventSource && progressEventSource.readyState === EventSource.CLOSED) {
                        console.log('å°è¯•é‡æ–°è¿æ¥è¿›åº¦ç›‘å¬...');
                        progressEventSource.close();
                        progressEventSource = null;
                        // é‡æ–°å»ºç«‹è¿æ¥
                        setTimeout(() => {
                            if (currentSessionId) {
                                startProgressListener();
                            }
                        }, 2000);
                    }
                }, 5000);
            };
        }
        
        function updateProgress(completed, total, percent, openPorts, speed, batchInfo) {
            progressFill.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressCompleted.textContent = completed;
            progressTotal.textContent = total;
            progressOpen.textContent = openPorts;
            progressSpeed.textContent = speed;
            
            // æ˜¾ç¤ºæ‰¹æ¬¡ä¿¡æ¯
            if (batchInfo) {
                document.getElementById('batchInfo').style.display = 'block';
                document.getElementById('progressBatch').textContent = batchInfo;
            } else {
                document.getElementById('batchInfo').style.display = 'none';
            }
        }
        
        async function fetchResults(retryCount = 0) {
            try {
                const response = await fetch(`/api/results?sessionId=${currentSessionId}`);
                if (!response.ok) {
                    if (response.status === 404 && retryCount < 3) {
                        // ä¼šè¯ä¸å­˜åœ¨ï¼Œç­‰å¾…ä¸€ä¸‹å†é‡è¯•
                        console.log(`é‡è¯•è·å–ç»“æœ (${retryCount + 1}/3)...`);
                        setTimeout(() => fetchResults(retryCount + 1), 1000);
                        return;
                    }
                    throw new Error(`è·å–ç»“æœå¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // éšè—è¿›åº¦ï¼Œæ˜¾ç¤ºç»“æœ
                progressContainer.style.display = 'none';
                scanBtn.disabled = false;
                scanBtn.textContent = 'ğŸš€ å¼€å§‹æ‰«æ';
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(data.results);
                
                currentSessionId = null;
                
            } catch (err) {
                if (retryCount < 3) {
                    console.log(`è·å–ç»“æœå¤±è´¥ï¼Œé‡è¯•ä¸­ (${retryCount + 1}/3):`, err.message);
                    setTimeout(() => fetchResults(retryCount + 1), 1000);
                } else {
                    showError('è·å–æ‰«æç»“æœå¤±è´¥: ' + err.message);
                    progressContainer.style.display = 'none';
                    scanBtn.disabled = false;
                    scanBtn.textContent = 'ğŸš€ å¼€å§‹æ‰«æ';
                }
            }
        }

        function displayResults(portResults) {
            const openPorts = portResults.filter(port => port.open);
            const closedPorts = portResults.filter(port => !port.open);
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${portResults.length}</div>
                    <div class="stat-label">æ€»ç«¯å£æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${openPorts.length}</div>
                    <div class="stat-label">å¼€æ”¾ç«¯å£</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${closedPorts.length}</div>
                    <div class="stat-label">å…³é—­ç«¯å£</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round((openPorts.length / portResults.length) * 100)}%</div>
                    <div class="stat-label">å¼€æ”¾ç‡</div>
                </div>
            `;
            
            // æ˜¾ç¤ºç«¯å£åˆ—è¡¨
            const portList = document.getElementById('portList');
            portList.innerHTML = '';
            
            // å…ˆæ˜¾ç¤ºå¼€æ”¾çš„ç«¯å£
            openPorts.forEach(port => {
                const portItem = createPortItem(port, true);
                portList.appendChild(portItem);
            });
            
            // å†æ˜¾ç¤ºå…³é—­çš„ç«¯å£
            closedPorts.forEach(port => {
                const portItem = createPortItem(port, false);
                portList.appendChild(portItem);
            });
            
            results.style.display = 'block';
        }

        function createPortItem(port, isOpen) {
            const portItem = document.createElement('div');
            portItem.className = `port-item ${isOpen ? 'open' : 'closed'}`;
            
            portItem.innerHTML = `
                <div class="port-info">
                    <div class="port-number">ç«¯å£ ${port.port}</div>
                    <div class="service-name">${port.service}</div>
                </div>
                <div class="status">${isOpen ? 'å¼€æ”¾' : 'å…³é—­'}</div>
            `;
            
            return portItem;
        }
    </script>
</body>
</html>


